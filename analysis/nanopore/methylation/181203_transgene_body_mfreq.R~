#!/usr/bin/Rscript
library(tidyverse)
library(GenomicRanges)
library(parallel)
library(getopt)
dir=dirname(get_Rscript_filename())
if (is.na(NA)) dir = "."
source(file.path(dir,"../methylation/methylation_plot_utils.R"))
cores = ceiling(detectCores()/2)

pdpath = "/shared/Data/chosigma_samples.txt"
outpath = "/dilithium/Data/tmp.rds"
mfreqdir = "/dilithium/Data/mfreq"
transdir = "/dilithium/Data/transgene"
regspath = "/dilithium/Data/NGS/Reference/cho/chok1/genome/Cricetulus_griseus_chok1gshd.sigmaIgG.fa.bins.shuffle20k.bed"
regspath = "/dilithium/Data/NGS/Reference/cho/chok1/genome/sigmaIgG.bed"
plotdir = "/dilithium/Data/plots"


pd = read_tsv(pdpath)
pd$day = factor(pd$day)
pd$filepath = file.path(transdir,paste0(pd$samples,".transgene.flank.meth.freq.txt"))

cnames=c("chrom","start","strand","meth","unmeth","dinuc","trinuc")
mfreq.list = mclapply(seq_along(pd$filepath),mc.cores=cores,function(i){
    read_tsv(pd$filepath[i],cnames) %>%
        mutate(sample=pd$samples[i])
})

mfreq = do.call(rbind,mfreq.list) %>%
    mutate(cov = meth+unmeth, freq = meth/cov) %>%
    filter(cov > 2 )
mfreq = bind_cols(mfreq,pd[match(mfreq$sample,pd$samples),-1]) %>%
    mutate(lab = paste(cell,glut))

g = ggplot(mfreq,aes(x=start,y=freq,color=lab,group=lab))+
    facet_wrap(.~day)+
    lims(x=c(15303000,15306000),y=c(0,1))+
    geom_vline(xintercept=15304000,linetype=2)+
    geom_point(size=0.5,alpha=0.5)+geom_smooth(size=0.5,se=F,span=0.7)+
    theme_bw()+
    labs(x="Coordinate along scaffold_16",y="Average methylation")+
    theme(panel.grid.major = element_blank(),                                                                                                             
          panel.grid.minor = element_blank(),                                                                                                             
          axis.text = element_text(color="black"),                                                                                                        
          legend.position="bottom")                                                                                                                          

plotpath = file.path(plotdir,"methylation_transgene_flanking_all.pdf")
pdf(plotpath,width=6,height=4,useDingbats=F)
print(g)
dev.off()
