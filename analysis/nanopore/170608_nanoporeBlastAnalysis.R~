library(GenomicRanges)
library(GenomicAlignments)
library(ggplot2)
library(reshape2)

plotdir="~/Dropbox/Data/ambic/nanopore/plots"
bamdir="/atium/Data/Nanopore/Analysis/170608_cho/hitbam_nometh/oldgenome/"
bampath="/atium/Data/Nanopore/Analysis/170608_cho/hitbam_nometh/oldgenome/170608_choIgGNIH_hits.sorted.bam"
adir="/atium/Data/Nanopore/Analysis/170608_cho/hitbam_nometh/analysis"

##bam inputs
bambp.names=read.table(file.path(adir,"bpNames.txt"),stringsAsFactors=F)[,1]
bam=readGAlignments(bampath)
bam.names=readGAlignments(bampath,use.names=T)

##granges for the breakpoints
bp.gr = GRanges(seqnames=c("KE379390","KE379503","KE379503","KE382060"),ranges=IRanges(start=c(131147,485274,6631618,5052404),width=1))
bprange.gr=resize(bp.gr,width=2000+width(bp.gr),fix="center")
bpone.gr=bprange.gr[4]

##find overlap bams
bpidx=queryHits(findOverlaps(bam.names,bpone.gr))
names.ovl=names(bam.names[bpidx])
allbpidx=which(names(bam.names) %in% names.ovl)
bam.bp=bam.names[bpidx]
bam.ins=bam.names[allbpidx]
## get number of occurrences
occ=data.frame(table(names(bam.names)))
occ=occ[order(occ$Freq,decreasing=T),]
one=as.character(occ$Var1[1])
bam.one=bam.names[which(names(bam.names)==one)]
bambp=bam.names[names(bam.names) %in% bambp.names]
x = bambp[which(names(bambp)==bambp.names[12])]

bam.df=as.data.frame(bam)

loc.df=bam.df[c("seqnames","start","end")]
loc.gr=GRanges(loc.df)

plasmid=as.character(loc.df$seqnames[length(loc.gr)])
chr=as.character(loc.df$seqnames)
chr.freq=table(chr)
max(chr.freq)

ind.plasmid = which(seqnames(loc.gr)==plasmid)
ind.genome = which(seqnames(loc.gr)!=plasmid)

genome.gr=loc.gr[ind.genome]
genome.chr=as.character(seqnames(genome.gr))
genome.freq=table(genome.chr)

sigchr.table=genome.freq[which(genome.freq>5)]
sigchr.df = as.data.frame(sigchr.table)
sigchr=as.character(sigchr.df$genome.chr)

bam.cov=coverage(loc.gr)
sig.cov=bam.cov[sigchr]

sig.df=data.frame(chr=character(),start=numeric(),end=numeric(),max=numeric())
for (chr in sigchr){
    print(chr)
    cov=(sig.cov[chr])
    covslice=slice(cov,3)[[1]]
    slice.df=data.frame(chr=chr,start=start(covslice),end=end(covslice),max=max(covslice))    
    sig.df=rbind(sig.df,slice.df)
    loc=start(covslice)[1]
}

write.table(x=sig.df,file=file.path(plotdir,"sig.txt"),sep="\t",quote=F)
chr=sigchr[2]
start=loc-20000
end=loc+20000
